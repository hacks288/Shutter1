<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Арена сверху</title>
<style>
body{margin:0;overflow:hidden;background:#111;font-family:sans-serif;}
canvas{display:block;}
#hud{position:absolute;top:10px;left:10px;color:#fff;font-size:16px;}
#joystick{position:absolute;bottom:60px;left:20px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,0.1);}
#stick{position:absolute;width:60px;height:60px;border-radius:50%;background:rgba(255,255,255,0.3);top:30px;left:30px;}
#attackBtn{position:absolute;bottom:80px;right:20px;width:80px;height:80px;border-radius:50%;background:#ff4d6d;color:#fff;font-size:18px;border:none;}
#restartBtn{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);padding:20px 40px;font-size:20px;background:#4dff6d;color:#111;border:none;border-radius:10px;display:none;}
#bossBarContainer{position:absolute;top:10px;left:50%;transform:translateX(-50%);width:60%;height:20px;background:#444;border:2px solid #888;border-radius:5px;display:none;}
#bossBar{height:100%;background:#a020f0;width:100%;border-radius:3px;}
#bossLabel{position:absolute;top:-20px;left:50%;transform:translateX(-50%);color:#fff;font-weight:bold;}
</style>
</head>
<body>
<div id="hud"></div>
<div id="joystick"><div id="stick"></div></div>
<button id="attackBtn">Бить</button>
<button id="restartBtn">Перезапустить</button>
<div id="bossBarContainer"><div id="bossLabel">BOSS</div><div id="bossBar"></div></div>
<canvas id="game"></canvas>
<script>
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');
let w,h;
function resize(){w=canvas.width=window.innerWidth;h=canvas.height=window.innerHeight;}
window.addEventListener('resize',resize);resize();

// Игрок
let player={x:0,y:0,size:40,hp:20,maxHp:20,attackRadius:60,handLength:45,attacking:false};

// Враги, пули, аптечки, эффекты
let bots=[],bullets=[],medkits=[],hitEffects=[];
let arena={w:1200,h:800};
let waveSize=5,waveTimer=0,totalWavesCompleted=0;
let boss=null,lastBossHitTime=0,lastRegenTime=0;

// ==================== НОВОЕ: Карты ====================
let blockSize = player.size; // 40
let maps = [
  // 1. Штольня
  [
    {x:-200,y:-200,w:5,h:1},{x:-200,y:-160,w:1,h:5},
    {x:-120,y:-200,w:1,h:8},{x:-200,y:80,w:8,h:1},
    {x:40,y:-120,w:6,h:1},{x:-40,y:-40,w:1,h:6}
  ],
  // 2. Поляна
  [
    {x:-200,y:-200,w:1,h:1},{x:-100,y:-50,w:1,h:1},
    {x:0,y:100,w:1,h:1},{x:200,y:-100,w:1,h:1},
    {x:100,y:0,w:1,h:1}
  ],
  // 3. Арена с колоннами
  [
    {x:-150,y:-150,w:1,h:1},{x:150,y:-150,w:1,h:1},
    {x:-150,y:150,w:1,h:1},{x:150,y:150,w:1,h:1},
    {x:0,y:0,w:2,h:2}
  ]
];
let currentMap = Math.floor(Math.random()*maps.length); // случайная карта

function collideWithMap(px,py){
  let blocks = maps[currentMap];
  for(let b of blocks){
    let left=b.x, top=b.y, right=b.x+b.w*blockSize, bottom=b.y+b.h*blockSize;
    if(px+player.size/2>left && px-player.size/2<right &&
       py+player.size/2>top && py-player.size/2<bottom){
      return true;
    }
  }
  return false;
}
function drawMap(){
  let blocks = maps[currentMap];
  ctx.fillStyle="#555";
  for(let b of blocks){
    ctx.fillRect(b.x,b.y,b.w*blockSize,b.h*blockSize);
  }
}

// Джойстик
let stick=document.getElementById('stick');
let joystick=document.getElementById('joystick');
let center={x:60,y:60};
let move={x:0,y:0};
stick.addEventListener('touchmove',e=>{
  e.preventDefault();
  let t=e.touches[0],r=joystick.getBoundingClientRect();
  let dx=t.clientX-r.left-center.x,dy=t.clientY-r.top-center.y;
  let d=Math.hypot(dx,dy);if(d>50){dx*=50/d;dy*=50/d;}
  move.x=dx/50*5;move.y=dy/50*5;
  stick.style.left=`${30+dx}px`;stick.style.top=`${30+dy}px`;
});
stick.addEventListener('touchend',()=>{move.x=0;move.y=0;stick.style.left='30px';stick.style.top='30px';});

// Атака игрока
let attackCooldown=0,attackMax=15;
function attack(){
  if(attackCooldown>0)return;
  attackCooldown=attackMax;player.attacking=true;
  for(let i=bots.length-1;i>=0;i--){
    let b=bots[i];
    let dist=Math.hypot(b.x-player.x,b.y-player.y);
    if(dist<player.attackRadius+b.size/2){
      let damage = dist<30 ? 5 : 3;
      b.hp-=damage;
      hitEffects.push({x:b.x,y:b.y,color:'#ff0',time:0});
      if(b.hp<=0){bots.splice(i,1);}
    }
  }
  if(boss){
    let dist=Math.hypot(boss.x-player.x,boss.y-player.y);
    if(dist<player.attackRadius+boss.size/2){
      let damage = dist<30 ? 5 : 3;
      boss.hp-=damage;
      hitEffects.push({x:boss.x,y:boss.y,color:'#ff0',time:0});
      lastBossHitTime=performance.now();
      if(boss.hp<=0){boss=null;document.getElementById('bossBarContainer').style.display='none';}
    }
  }
  setTimeout(()=>{player.attacking=false;},200);
}
document.getElementById('attackBtn').addEventListener('touchstart',attack);

// Аптечки
function spawnMedkit(){
  let x,y;
  do {x=Math.random()*arena.w-arena.w/2;y=Math.random()*arena.h-arena.h/2;} 
  while(Math.hypot(player.x-x,player.y-y)<100);
  return {x,y,size:25,heal:10,time:0};
}

// Враги
function spawnWave(n){
  for(let i=0;i<n;i++){
    bots.push({x:Math.random()*arena.w-arena.w/2,y:Math.random()*arena.h-arena.h/2,size:40,hp:20,speed:1.5,ammo:3,reload:0});
  }
}

// Боссы
const bossTypes = [
  {name:'Громила',size:80,hp:100,speed:1,attackMax:180,handLength:100,damage:5,color:'#a020f0'},
  {name:'Стрелок',size:60,hp:80,speed:1.5,attackMax:90,handLength:0,damage:0,color:'#20a0f0'},
  {name:'Быстрый',size:50,hp:60,speed:2,attackMax:120,handLength:80,damage:4,color:'#f0a020'}
];
let bossIndex=0;
function spawnBoss(){
  let type = bossTypes[bossIndex % bossTypes.length]; bossIndex++;
  boss = {
    x:0,y:-200,size:type.size,hp:type.hp,maxHp:type.hp,speed:type.speed,
    attackCooldown:0,attackMax:type.attackMax,handLength:type.handLength,
    lastHandHitTime:0,damage:type.damage,color:type.color,name:type.name
  };
  document.getElementById('bossBarContainer').style.display='block';
  document.getElementById('bossBar').style.width='100%';
}

// Инициализация
function init(){
  player.hp=player.maxHp;player.x=0;player.y=0;
  bots=[];bullets=[];medkits=[];hitEffects=[];waveSize=5;waveTimer=0;totalWavesCompleted=0;
  boss=null;lastBossHitTime=0;lastRegenTime=0;
  document.getElementById('restartBtn').style.display='none';
  document.getElementById('bossBarContainer').style.display='none';
  currentMap=Math.floor(Math.random()*maps.length); // новая случайная карта
  spawnWave(waveSize);
}

// HUD
function updateHUD(){
  document.getElementById('hud').innerHTML=`HP:${player.hp}<br>Врагов:${bots.length}${boss?'<br>Босс '+boss.name+' HP:'+boss.hp:''}`;
  if(boss){
    let percent=Math.max(boss.hp/boss.maxHp,0);
    document.getElementById('bossBar').style.width=(percent*100)+"%";
  }
}

// Обновление
function update(){
  if(player.hp<=0)return;
  let prevX=player.x, prevY=player.y;
  player.x+=move.x;player.y+=move.y;
  player.x=Math.max(-arena.w/2+player.size/2,Math.min(arena.w/2-player.size/2,player.x));
  player.y=Math.max(-arena.h/2+player.size/2,Math.min(arena.h/2-player.size/2,player.y));
  if(collideWithMap(player.x,player.y)){player.x=prevX;player.y=prevY;}

  if(Math.random()<0.02&&medkits.length<5)medkits.push(spawnMedkit());
  for(let i=medkits.length-1;i>=0;i--){
    let m=medkits[i];m.time++;
    if(Math.hypot(player.x-m.x,player.y-m.y)<player.size/2+m.size/2){
      player.hp=Math.min(player.hp+m.heal,player.maxHp);
      hitEffects.push({x:m.x,y:m.y,color:'#0ff',time:0});medkits.splice(i,1);
    } else if(m.time>300)medkits.splice(i,1);
  }

  // Враги
  for(let i=bots.length-1;i>=0;i--){
    let b=bots[i]; let angle=Math.atan2(player.y-b.y,player.x-b.x);
    b.x+=Math.cos(angle)*b.speed; b.y+=Math.sin(angle)*b.speed;
    if(b.reload>0)b.reload--;
    if(Math.random()<0.01){
      if(b.ammo>0){
        bullets.push({x:b.x,y:b.y,dx:(player.x-b.x)/160,dy:(player.y-b.y)/160,radius:10,color:'#ff0'});
        b.ammo--;
      } else if(b.reload<=0){b.reload=200;b.ammo=3;}
    }
  }

  // Боссы
  if(boss){
    let angle=Math.atan2(player.y-boss.y,player.x-boss.x);
    boss.x+=Math.cos(angle)*boss.speed; boss.y+=Math.sin(angle)*boss.speed;
    let now = performance.now();
    if(now-lastBossHitTime>5000 && now-lastRegenTime>3000){boss.hp=Math.min(boss.hp+10,boss.maxHp);lastRegenTime=now;}

    if(boss.attackCooldown>0) boss.attackCooldown--;
    else {boss.attackCooldown=boss.attackMax;
      if(boss.handLength===0){
        for(let i=-12;i<=12;i++){
          let ang=angle+i*0.05;
          bullets.push({x:boss.x,y:boss.y,dx:Math.cos(ang)/4,dy:Math.sin(ang)/4,radius:10,color:'#f0f',trail:[]});
        }
      }
    }

    if(boss.handLength>0 && now-boss.lastHandHitTime>500){
      let d=Math.hypot(player.x-boss.x,player.y-boss.y);
      if(d<boss.handLength){player.hp-=boss.damage; hitEffects.push({x:player.x,y:player.y,color:'#f00',time:0}); boss.lastHandHitTime=now;}
    }
  }

  // Пули
  for(let i=bullets.length-1;i>=0;i--){
    let b=bullets[i]; if(!b.trail)b.trail=[];
    b.trail.push({x:b.x,y:b.y}); if(b.trail.length>10)b.trail.shift();
    b.x+=b.dx*5; b.y+=b.dy*5;
    if(Math.hypot(b.x-player.x,b.y-player.y)<player.size/2){player.hp-=2; hitEffects.push({x:player.x,y:player.y,color:'#f0f',time:0}); bullets.splice(i,1);}
    else if(b.x<-arena.w/2||b.x>arena.w/2||b.y<-arena.h/2||b.y>arena.h/2){bullets.splice(i,1);}
  }

  if(attackCooldown>0)attackCooldown--;

  // Волны
  if(!boss && bots.length===0){waveTimer++;if(waveTimer>240 && waveSize>0){spawnWave(waveSize);waveSize--;waveTimer=0;totalWavesCompleted++;}if(totalWavesCompleted>=2) spawnBoss();}
}

// Рисование
function draw(){
  ctx.clearRect(0,0,w,h);
  ctx.save(); ctx.translate(w/2-player.x,h/2-player.y);
  ctx.fillStyle='#222';ctx.fillRect(-arena.w/2,-arena.h/2,arena.w,arena.h);

  drawMap(); // рисуем карту

  medkits.forEach(m=>{
    let glow=Math.sin(m.time/10)*0.3+0.7;
    ctx.save();ctx.translate(m.x,m.y);ctx.scale(glow,glow);
    ctx.fillStyle='#00f'; ctx.beginPath(); ctx.arc(0,0,m.size/2,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='#fff'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(-8,0); ctx.lineTo(8,0); ctx.moveTo(0,-8); ctx.lineTo(0,8); ctx.stroke();
    ctx.restore();
  });

  ctx.fillStyle='#4dff6d'; ctx.beginPath(); ctx.arc(player.x,player.y,player.size/2,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#fff'; ctx.font='16px sans-serif'; ctx.textAlign='center'; ctx.fillText(player.hp,player.x,player.y+5);

  if(player.attacking){
    let nearest=null,distMin=Infinity;
    bots.forEach(b=>{let d=Math.hypot(b.x-player.x,b.y-player.y); if(d<distMin){distMin=d;nearest=b;}});
    if(nearest){let angle=Math.atan2(nearest.y-player.y,nearest.x-player.x);
      ctx.strokeStyle='#4dff6d';ctx.lineWidth=6;
      ctx.beginPath();ctx.moveTo(player.x,player.y);ctx.lineTo(player.x+Math.cos(angle)*player.handLength,player.y+Math.sin(angle)*player.handLength);ctx.stroke();
    }
  }

  bots.forEach(b=>{ctx.fillStyle='#ff4d4d';ctx.beginPath();ctx.arc(b.x,b.y,b.size/2,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#fff';ctx.fillText(b.hp,b.x,b.y+5); if(b.reload>0){ctx.fillStyle='#fff';ctx.font='12px sans-serif';ctx.fillText('Reload',b.x,b.y-b.size/2-10);}});
  
  bullets.forEach(b=>{for(let j=0;j<b.trail.length;j++){let t=b.trail[j];ctx.fillStyle=`rgba(255,0,255,${j/b.trail.length})`;ctx.beginPath();ctx.arc(t.x,t.y,b.radius/2,0,Math.PI*2);ctx.fill();}});

  if(boss){
    ctx.fillStyle=boss.color; ctx.beginPath(); ctx.arc(boss.x,boss.y,boss.size/2,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#fff'; ctx.fillText(boss.hp,boss.x,boss.y+5);
    if(boss.handLength>0){let angle=Math.atan2(player.y-boss.y,player.x-boss.x);
      ctx.strokeStyle='#a0a0ff'; ctx.lineWidth=10;
      ctx.beginPath(); ctx.moveTo(boss.x,boss.y);
      ctx.lineTo(boss.x+Math.cos(angle)*boss.handLength,boss.y+Math.sin(angle)*boss.handLength);
      ctx.stroke();
    }
  }

  drawHitEffects();
  ctx.restore();
}

// Эффекты попаданий
function drawHitEffects(){for(let i=hitEffects.length-1;i>=0;i--){let h=hitEffects[i];h.time++;ctx.fillStyle=h.color;ctx.beginPath();ctx.arc(h.x,h.y,10